<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssg.dojangfarm.dao.mybatis.mapper.AuctionMapper">
  <cache />
  	<!-- Auction -->
  	<select id="getAuctionList" resultType="Auction">
    	SELECT 
    		aNo, title, minPrice, deadline,
    		imPurPrice, bidPrice 
    	FROM Auction
    	ORDER BY aNo
  	</select>
  	
  	<select id="findAuctionByTitle" parameterType="String" resultType="Auction">
    	SELECT 
    		Auction.aNo, title, minPrice, deadline,
    		imPurPrice, bidPrice 
    	FROM Auction
    	WHERE 
    		title LIKE #{paramValue}
    	ORDER BY Auction.aNo
  	</select>
  	
  	<select id="findAuctionByProduct" parameterType="String" resultType="Auction">
    	SELECT 
    		Auction.aNo, title, minPrice, deadline,
    		imPurPrice, Auction.bidPrice 
    	FROM Auction, Product
    	WHERE 
    		Auction.pNo = Product.pNo AND
    		Product.pName LIKE #{paramValue}
    	ORDER BY Auction.aNo
    		
  	</select>
  	
  	<select id="getMyAuctionList" parameterType="int" resultType="Auction">
    	SELECT 
    		Auction.aNo, title, minPrice, deadline,
    		imPurPrice, bidPrice, finish 
    	FROM Auction
    	WHERE 
    		userNo = #{userNo}
    	ORDER BY Auction.aNo
  	</select>
  	
  	<select id="getAuction" parameterType="int" resultType="Auction">
    	SELECT 
    		aNo, title, detail, minPrice, deadline,
    		imPurAva, imPurPrice, finish, 
    		Auction.userNo AS "user.userNo", id AS "user.id",
    		 Auction.pNo AS "product.pNo", pName
    	FROM Auction, Product, UserTable
    	WHERE 
    		Auction.pNo = Product.pNo AND
    		Auction.userNo = UserTable.userNo AND
    		aNo = #{aNo}
  	</select>
  	
  	<insert id="registerAuction" parameterType="Auction">
  		<selectKey keyProperty="aNo" resultType="int" order="BEFORE">
        	SELECT AuctionSeq.nextval AS "aNo" FROM DUAL
     	</selectKey>
    	INSERT INTO Auction 
    		(aNo, title, detail, minPrice, deadline,
    		imPurAva, imPurPrice, userNo, pNo)
    	VALUES 
    		(#{aNo}, #{title}, #{detail}, #{minPrice}, #{deadline}, 
    		#{imPurAva}, #{imPurPrice}, #{user.userNo}, #{product.pNo})
  	</insert>
  	
  	<select id="getUserNoByAuction" parameterType="int" resultType="User">
    	SELECT 
    		userNo
    	FROM Auction
    	WHERE 
    		aNo = #{aNo}
  	</select>
  	
  	
  	
  	
  	<select id="getMyBidList" parameterType="int" resultType="Bid">
    	SELECT 
    		bidNo, Bid.bidPrice, state, deadline, title, Auction.aNo
    	FROM Bid, Auction
    	WHERE 
    		Auction.aNo = Bid.aNo AND
    		userNo = #{userNo}
    	ORDER BY Bid.bidNo
  	</select>
  	
  	
  	<select id="getBid" parameterType="int" resultType="Bid">
    	SELECT 
    		bidNo, Bid.bidPrice, state, deadline, title, Auction.aNo
    	FROM Bid, Auction
    	WHERE 
    		Auction.aNo = Bid.aNo AND
    		bidNo = #{bidNo}
  	</select>
  	
  	<insert id="bidAuction" parameterType="Bid">
  		<selectKey keyProperty="bidNo" resultType="int" order="BEFORE">
        	SELECT BidSeq.nextval AS "bidNo" FROM DUAL
     	</selectKey>
    	INSERT INTO Bid 
    		(bidNo, bidPrice, userNo, aNo)
    	VALUES 
    		(#{bidNo}, #{bidPrice}, #{user.userNo}, #{auction.aNo})
  	</insert>
  	
  	
  	
  	
  
  	<select id="getMySBidList" parameterType="int" resultType="Auction">
    	SELECT 
    		sBidNo, payState, Auction.aNo, Bid.bidNo, Bid.bidPrice
    	FROM SBid, Auction, Bid
    	WHERE 
    		Bid.bidNo = SBid.bidNo AND
    		Auction.aNo = Bid.aNo AND
    		SBid.userNo = #{userNo}
    	ORDER BY SBid.sBidNo
  	</select>
  	
  	<select id="getMySBid" parameterType="int" resultType="Auction">
    	SELECT 
    		sBidNo, payState, Auction.aNo, title, Bid.bidNo, bid.bidPrice,
    		Delivery.dNo AS "delivery.dNo",
    		Payment.payNo AS "payment.payNo"
    	FROM SBid, Bid, Auction, Delivery, Payment
    	WHERE 
    		Bid.bidNo = SBid.bidNo AND
    		Auction.aNo = Bid.aNo AND
    		Delivery.dNo = SBid.dNo AND
    		Payment.payNo = SBid.payNo AND
    		sBidNo = #{sBidNo}
  	</select>
  	
  	<select id="getSBidByAuction" parameterType="int" resultType="Auction">
    	SELECT 
    		sBidNo, Auction.aNo, title, imPurPrice, 
    		UserTable.userNo AS "user.userNo", Bid.bidNo, id AS "user.id"
    	FROM SBid, Bid, UserTable, Auction
    	WHERE 
    		Bid.bidNo = SBid.bidNo AND
    		Auction.aNo = Bid.aNo AND
    		Bid.userNo = UserTable.userNo AND
    		Bid.userNo = #{userNo}
  	</select>
  	
  	<insert id="successBid" parameterType="SBid">
  		<selectKey keyProperty="sBidNo" resultType="int" order="BEFORE">
        	SELECT SBidSeq.nextval AS "sBidNo" FROM DUAL
     	</selectKey>
    	INSERT INTO ImPur 
    		(sBidNo, bidNo, dNo, payNo)
    	VALUES 
    		(#{imPurNo}, #{bid.bidNo}, #{delivery.dNo}, #{payment.payNo})
  	</insert>
  	
  	
  	
  	
  	
  	<select id="getMyImPurList" parameterType="int" resultType="Auction">
    	SELECT 
    		imPurNo, Auction.aNo, title, imPurPrice
    	FROM ImPur, Auction
    	WHERE 
    		Auction.aNo = ImPur.aNo AND
    		ImPur.userNo = #{userNo}
    	ORDER BY ImPur.imPurNo
  	</select>
  	
  	<select id="getMyImPur" parameterType="int" resultType="Auction">
    	SELECT 
    		imPurNo, Auction.aNo, title, imPurPrice,
    		Delivery.dNo AS "delivery.dNo",
    		Payment.payNo AS "payment.payNo"
    	FROM ImPur, Auction, Delivery, Payment
    	WHERE 
    		Auction.aNo = ImPur.aNo AND
    		Delivery.dNo = ImPur.dNo AND
    		Payment.payNo = ImPur.payNo AND
    		imPurNo = #{imPurNo}
  	</select>
  	
  	<select id="getImPurByAuction" parameterType="int" resultType="Auction">
    	SELECT 
    		imPurNo, Auction.aNo, title, imPurPrice, 
    		UserTable.userNo AS "user.userNo", id AS "user.id"
    	FROM ImPur, Auction, UserTable
    	WHERE 
    		Auction.aNo = ImPur.aNo AND
    		UserTable.userNo = ImPur.userNo AND
    		ImPur.userNo = #{userNo}
  	</select>
  	
  	<insert id="immePurchase" parameterType="ImPur">
  		<selectKey keyProperty="imPurNo" resultType="int" order="BEFORE">
        	SELECT ImPurSeq.nextval AS "imPurNo" FROM DUAL
     	</selectKey>
    	INSERT INTO ImPur 
    		(imPurNo, userNo, aNo, dNo, payNo)
    	VALUES 
    		(#{imPurNo}, #{user.userNo}, #{auction.aNo}, 
    		 #{delivery.dNo}, #{payment.payNo})
  	</insert>
  	
  	<update id="updateBidPrice">
    	UPDATE Auction SET 
    		bidPrice = #{bidPrice}
    	WHERE aNo = #{aNo}
  	</update>
  	
  	
 </mapper>